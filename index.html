<html>
  <head>
    <title>CS 4460 homework 5</title>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        width: 800px;
        margin: 0 auto;
      }

      #location {
        height: 30px;
        margin-bottom: 0;
      }

      #d3_container svg {
        padding: 30px;
      }

      .axis {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .axis text {
        font: 15px 'Arial';
      }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v2.js"></script>
    <script>
      $(document).ready(function() {
        var json = undefined;

        $('#search').click(function(e) {
          e.preventDefault();

          var userLocation = $('#location').val();
          var url = "http://api.wunderground.com/api/5e622022ab838954/conditions/tide/hourly10day/q/"+userLocation+".json";

          $.ajax({
            url: url,
            dataType: "jsonp",
            success: function(weatherData) {
              $('#temp_hover').html('&nbsp;');
              $('#temperature').html('');
              $('#humidity').html('');
              console.log(weatherData);
              temperature(weatherData);
              humidity(weatherData);
            }
          });

          url = "http://api.wunderground.com/api/5e622022ab838954/rawtide/q/"+userLocation+".json"
          $.ajax({
            url: url,
            dataType: "jsonp",
            success: function(tideData) {
              console.log(tideData);
              tide(tideData);
            }
          });
        });
      });

      function extract(json, key, amount, secondary_key) {
        var data = []
        for (i=0; i<amount; i++) {
          if (secondary_key) {
            data[i] = json.hourly_forecast[i][key][secondary_key]
          } else {
            data[i] = json.hourly_forecast[i][key]
          }
        }
        return data;
      }

      function extractTide(json, amount) {
        var data = []
        for (i=0; i<amount; i++) {
          data[i] = json.rawtide.rawTideObs[i].height;
        }
        return data;
      }

      function temperature(json) { 
        var data = extract(json, 'temp', 72, 'english')

        var path = [];
        for (i=0; i<data.length; i++) {
          path[i] = {x: i, y: data[i]};
        }

        var color = d3.scale.category20c();

        var width  = 800,
            height = 500;

        var x = d3.scale.linear()
            .domain([0, 72])
            .range([0, width]);

        var y = d3.scale.linear()
            .domain([0,100])
            .range([height, 0]);

        var line = d3.svg.line()
            .x(function(d){return x(d.x)})
            .y(function(d){return y(d.y)})
            .interpolate("linear");

        var chart = d3.select("#temperature").append("svg:svg")
            .attr("width", width)
            .attr("height", height)

        chart.append("svg:path")
            .attr("d", line(path))
            .style("stroke-width", 2)
            .style("stroke", "steelblue")
            .style("fill", "none");

        var dots = chart.selectAll("circles")
            .data(path, function(d) {return d})
            .attr("cx", function(d) {return d.x})
            .attr("cy", function(d) {return d.y});

        dots.enter().append("svg:circle")
            .attr("r", 3)
            .attr("cx", function(d) {return x(d.x)})
            .attr("cy", function(d) {return y(d.y)})
            .style("stroke-width", 2)
            .style("stroke", "steelblue")
            .style("fill", "#ffffff")
            .on("mouseover", function(d) {$('#temp_hover').html('In ' + d.x + ' hours it will be ' + d.y + 'F')})
            .on("mouseout", function(){$('#temp_hover').html('&nbsp;')});

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        chart.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + y.range()[0] + ")")
            .call(xAxis);

        chart.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        chart.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "end")
            .attr("x", width)
            .attr("y", height - 5)
            .text("time in hours");

        chart.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "end")
            .attr("x", 0)
            .attr("y", 15)
            .attr("transform", "rotate(-90)")
            .text("temperature in F");
      }

      function humidity(json) {
        var data = extract(json, 'humidity', 72)

        var area_data = [];
        for (i=0; i<data.length; i++) {
          area_data[i] = {hour: i, humidity: data[i]};
        }

        var color = d3.scale.category20c();

        var width  = 800,
            height = 500;

        var x = d3.scale.linear()
            .domain([0,72])
            .range([0, width]);

        var y = d3.scale.linear()
            .domain([0,100])
            .range([height, 0]);

        // An area generator, for the light fill.
        var area = d3.svg.area()
            .interpolate("monotone")
            .x(function(d) { return x(d.hour); })
            .y0(height)
            .y1(function(d) { return y(d.humidity); });

        // A line generator, for the dark stroke.
        var line = d3.svg.line()
            .interpolate("monotone")
            .x(function(d) { return x(d.hour); })
            .y(function(d) { return y(d.humidity); });

        var chart = d3.select("#humidity").append("svg:svg")
            .attr("width", width)
            .attr("height", height)

        // Add the area path elements. Note: the y-domain is set per element.
        chart.append("svg:path")
            .attr("class", "area")
            .attr("d", area(area_data))
            .attr("fill", "steelblue");
      
        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        chart.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + y.range()[0] + ")")
            .call(xAxis);

        chart.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        chart.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "end")
            .attr("x", width)
            .attr("y", height - 5)
            .text("time in hours");

        chart.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "end")
            .attr("x", 0)
            .attr("y", 15)
            .attr("transform", "rotate(-90)")
            .text("humidity %");

      }

      function tide(json) {
        var data = extractTide(json, 72);

        var tide_data = [];
        var min = data[0];
        var max = data[1];
        for (i=0; i<data.length; i++) {
          tide_data[i] = {hour: i, height: data[i]};
          if (data[i] < min) {min = data[i]}
          if (data[i] > max) {max = data[i]}
        }

        var color = d3.scale.category20c();

        var width  = 800,
            height = 500;

        var x = d3.scale.linear()
            .domain([0, 72])
            .range([0, width]);

        var y = d3.scale.linear()
            .domain([max+1,min-1])
            .range([height, 0]);

        var chart = d3.select("#tide").append("svg:svg")
            .attr("width", width)
            .attr("height", height);

        chart.selectAll("rect")
            .data(tide_data)
            .enter().append("svg:rect")
            .attr("x", function(d, i) {return i*11})
            .attr("y", function(d) {return height-y(d.height)})
            .attr("height", function(d) {return y(d.height)})
            .attr("width", 10)
            .attr("fill", "#2d578b")
            .on("mouseover", function(d) {$('#tide_hover').html('The tide will be ' + d.height)});

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        y = d3.scale.linear()
            .domain([min-1,max+1])
            .range([height, 0]);

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        chart.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + y.range()[0] + ")")
            .call(xAxis);

        chart.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        chart.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "end")
            .attr("x", width)
            .attr("y", height - 5)
            .text("time in hours");

        chart.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "end")
            .attr("x", 0)
            .attr("y", 15)
            .attr("transform", "rotate(-90)")
            .text("tide height");

      }
    </script>
  </head>
  <body>
    <h1>Weather Dashboard</h1>
    <form>
      <input type="text" id="location" placeholder="Zipcode...">
      <input type="submit" id="search" class="btn primary">
    </form>

    <div id="d3_container">
      <h2>Temperate Data</h2>
      <p id="temp_hover">&nbsp;</p>
      <div id="temperature">
      </div>

      <h2>Humidity Data</h2>
      <div id="humidity">
      </div>

      <h2>Tide Data</h2>
      <p id="tide_hover">&nbsp;</p>
      <div id="tide">
      </div>
    </div>
  </body>
</html>
